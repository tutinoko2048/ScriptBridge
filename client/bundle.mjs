// @ts-check
// for bundled release
import { readFile, writeFile, rename } from 'node:fs/promises';
import { build } from 'tsup';
import { dtsPlugin } from "esbuild-plugin-d.ts";
import { sharedOptions } from './tsup.config.mjs';

console.log('Bundling script-bridge-client...');

const packageJson = JSON.parse(await readFile('package.json', 'utf8'));
const header = `// AUTOGENERATED FILE. DO NOT EDIT.
//
// @script-bridge/client@${packageJson.version}
// author: ${packageJson.author}
// license: ${packageJson.license}
// repository: ${packageJson.homepage}
//`;

const outDir = 'build'

await build({
  ...sharedOptions,
  outDir,
  noExternal: ['@script-bridge/protocol'],
  bundle: true,
  minify: true,
  dts: false,
  banner: {
    js: header,
  },
  esbuildPlugins: [
    dtsPlugin({
      experimentalBundling: true,
      outDir,
    })
  ],
});

await rename('build/index.mjs', 'build/script-bridge-client.js');
await rename('build/index.d.ts', 'build/script-bridge-client.d.ts');

await writeFile(
  'build/script-bridge-client.d.ts',
  header + '\n' + (await readFile('build/script-bridge-client.d.ts', 'utf8'))
);

console.log('Bundle complete');